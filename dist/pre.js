import{a as _,b as g}from"./chunk-PFWPZI57.js";import{c as a,e as d}from"./chunk-UJFNRH2W.js";var e=a(d(),1),t=a(_(),1),k=a(g(),1);import s from"node:process";import v from"node:util";async function $(){let r=e.getInput("slack-bot-token")||s.env.SLACK_BOT_TOKEN,l=e.getInput("slack-ts"),c=e.getInput("slack-channel-id")||s.env.SLACK_CHANNEL_ID,I=e.getInput("status",{required:!0}),f=e.getInput("github-token",{required:!0}),n=(0,t.getOctokit)(f),b=new k.WebClient(r);if(!r)throw new Error("Missing input slack-bot-token or environment variable SLACK_BOT_TOKEN");if(l)e.saveState("slack-ts",l);else if(c){e.info(JSON.stringify({context:t.context,env:s.env},null,2));let h=await n.paginate(n.rest.actions.listJobsForWorkflowRunAttempt,{...t.context.repo,run_id:t.context.runId,attempt_number:Number.parseInt(s.env.GITHUB_RUN_ATTEMPT||"1",10)}),w=await n.paginate(n.rest.actions.listJobsForWorkflowRun,{...t.context.repo,run_id:t.context.runId});console.log(JSON.stringify(w,null,2));let i=`${t.context.repo.owner}/${t.context.repo.repo}`,u=`https://github.com/${i}`,p=[{label:"Repo",url:u,value:i},{label:"Workflow",url:`${u}/actions/runs/${t.context.runId}`,value:t.context.workflow},{label:"Author",url:`https://github.com/${t.context.actor}`,value:t.context.actor}];t.context.payload.pull_request?.html_url&&p.push({label:"PR",url:t.context.payload.pull_request.html_url,value:`#${t.context.payload.pull_request.number}`});let m=await b.chat.postMessage({channel:c,text:`${t.context.workflow}`,unfurl_links:!1,attachments:[{preview:{can_remove:!1,type:"text"},color:"#d4ad3c",blocks:[{block_id:"info",type:"context",elements:p.map(o=>({type:"mrkdwn",text:`*${o.label}*     
<${o.url}|${o.value}>     `}))},{block_id:"jobs",type:"section",text:{type:"mrkdwn",text:h.map(o=>`<${o.html_url}|:tada: ${o.name}>`).join(" --> ")}}]}]});if(!m.ts)throw new Error("Did not get slack ts");e.saveState("slack-ts",m.ts)}else throw new Error("missing input slack-ts or channel-id");e.saveState("start",Date.now())}$().catch(r=>{e.error(`ksmithut/slack-stream-action: ${v.format(r)}`)});export{$ as run};
