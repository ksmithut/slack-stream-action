import{a as _,b as $}from"./chunk-PFWPZI57.js";import{c as i,e as w}from"./chunk-UJFNRH2W.js";var o=i(w(),1),e=i(_(),1),g=i($(),1);import p from"node:process";import b from"node:util";async function h(t,r){return(await t.paginate(t.rest.actions.listJobsForWorkflowRunAttempt,{...r.repo,run_id:r.runId,attempt_number:Number.parseInt(process.env.GITHUB_RUN_ATTEMPT||"1",10)})).map(n=>{n.started_at;let s=v(n),a=T(n),l=a?` ${a}`:"";return`<${n.html_url}|:${s}: ${n.name}${l}>`}).join(" --> ")}function v(t){if(t.status==="queued")return"slack-stream-pending";if(t.status==="in_progress")return"slack-stream-running";if(t.status==="completed"){if(t.conclusion==="success")return"slack-stream-success";if(t.conclusion==="failure")return"slack-stream-failure";if(t.conclusion==="cancelled")return"slack-stream-cancelled"}throw new Error(`unknown status: ${t.status}, conclusion: ${t.conclusion}`)}function T(t){if(!t.completed_at)return null;let r=new Date(t.completed_at),c=new Date(t.started_at),n=r.getTime()-c.getTime(),s=Math.floor(n/1e3),a=Math.floor(s/60),l=s%60;return`${a}:${String(l).padStart(2,"0")}`}async function S(){let t=o.getInput("slack-bot-token")||p.env.SLACK_BOT_TOKEN,r=o.getInput("slack-ts"),c=o.getInput("slack-channel-id")||p.env.SLACK_CHANNEL_ID,n=o.getInput("status",{required:!0}),s=o.getInput("github-token",{required:!0}),a=(0,e.getOctokit)(s),l=new g.WebClient(t);if(!t)throw new Error("Missing input slack-bot-token or environment variable SLACK_BOT_TOKEN");if(r)o.saveState("slack-ts",r);else if(c){o.info(JSON.stringify({context:e.context,env:p.env},null,2));let m=`${e.context.repo.owner}/${e.context.repo.repo}`,f=`https://github.com/${m}`,d=[{label:"Repo",url:f,value:m},{label:"Workflow",url:`${f}/actions/runs/${e.context.runId}`,value:e.context.workflow},{label:"Author",url:`https://github.com/${e.context.actor}`,value:e.context.actor}];e.context.payload.pull_request?.html_url&&d.push({label:"PR",url:e.context.payload.pull_request.html_url,value:`#${e.context.payload.pull_request.number}`});let k=await l.chat.postMessage({channel:c,text:`${e.context.workflow}`,unfurl_links:!1,attachments:[{preview:{can_remove:!1,type:"text"},color:"#d4ad3c",blocks:[{block_id:"info",type:"context",elements:d.map(u=>({type:"mrkdwn",text:`*${u.label}*     
<${u.url}|${u.value}>     `}))},{block_id:"jobs",type:"section",text:{type:"mrkdwn",text:await h(a,e.context)}}]}]});if(!k.ts)throw new Error("Did not get slack ts");o.saveState("slack-ts",k.ts)}else throw new Error("missing input slack-ts or channel-id");o.saveState("start",Date.now())}S().catch(t=>{o.error(`ksmithut/slack-stream-action: ${b.formatWithOptions({depth:3},t)}`)});export{S as run};
