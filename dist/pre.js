import{a as _,b as $}from"./chunk-PFWPZI57.js";import{c as i,e as w}from"./chunk-UJFNRH2W.js";var n=i(w(),1),e=i(_(),1),h=i($(),1);import p from"node:process";import b from"node:util";async function g(t,r){return(await t.paginate(t.rest.actions.listJobsForWorkflowRunAttempt,{...r.repo,run_id:r.runId,attempt_number:Number.parseInt(process.env.GITHUB_RUN_ATTEMPT||"1",10)})).map(o=>{o.started_at;let s=T(o),a=v(o),l=a?` ${a}`:"";return`<${o.html_url}|:${s}: ${o.name}${l}>`}).join(" --> ")}function T(t){if(t.status==="queued")return"slack-stream-pending";if(t.status==="in_progress")return"slack-stream-running";if(t.status==="completed"){if(t.conclusion==="success")return"slack-stream-success";if(t.conclusion==="failure")return"slack-stream-failure";if(t.conclusion==="cancelled")return"slack-stream-cancelled"}throw new Error(`unknown status: ${t.status}, conclusion: ${t.conclusion}`)}function v(t){if(!t.completed_at)return null;let r=new Date(t.completed_at),c=new Date(t.started_at),o=r.getTime()-c.getTime(),s=Math.floor(o/1e3),a=Math.floor(s/60),l=s%60;return`${a}:${String(l).padStart(2,"0")}`}async function S(){let t=n.getInput("slack-bot-token")||p.env.SLACK_BOT_TOKEN,r=n.getInput("slack-ts"),c=n.getInput("slack-channel-id")||p.env.SLACK_CHANNEL_ID,o=n.getInput("status",{required:!0}),s=n.getInput("github-token",{required:!0}),a=(0,e.getOctokit)(s),l=new h.WebClient(t);if(!t)throw new Error("Missing input slack-bot-token or environment variable SLACK_BOT_TOKEN");if(r)n.saveState("slack-ts",r);else if(c){n.info(JSON.stringify({context:e.context,env:p.env},null,2));let m=`${e.context.repo.owner}/${e.context.repo.repo}`,f=`https://github.com/${m}`,k=[{label:"Repo",url:f,value:m},{label:"Workflow",url:`${f}/actions/runs/${e.context.runId}`,value:e.context.workflow},{label:"Author",url:`https://github.com/${e.context.actor}`,value:e.context.actor}];e.context.payload.pull_request?.html_url&&k.push({label:"PR",url:e.context.payload.pull_request.html_url,value:`#${e.context.payload.pull_request.number}`});let d=await l.chat.postMessage({channel:c,text:`${e.context.workflow}`,unfurl_links:!1,blocks:[{block_id:"info",type:"context",elements:k.map(u=>({type:"mrkdwn",text:`*${u.label}*     
<${u.url}|${u.value}>     `}))},{block_id:"jobs",type:"section",text:{type:"mrkdwn",text:await g(a,e.context)}}]});if(!d.ts)throw new Error("Did not get slack ts");n.saveState("slack-ts",d.ts)}else throw new Error("missing input slack-ts or channel-id");n.saveState("start",Date.now())}S().catch(t=>{n.error(`ksmithut/slack-stream-action: ${b.formatWithOptions({depth:3},t)}`)});export{S as run};
